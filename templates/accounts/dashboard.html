{% extends "base.html" %}
{% block title %}Dashboard · StudyWithKimy{% endblock %}
{% block content %}
<h2>Dashboard</h2>

<section>
  <h3>Notifications</h3>
  <ul>
    {% for n in notifications %}
      <li><small>{{ n.created_at|date:"Y-m-d H:i" }}</small> — {{ n.type }} — {{ n.payload.course }} {{ n.payload.material_title }}</li>
    {% empty %}<li>All caught up!</li>{% endfor %}
  </ul>
  <form action="/api/notifications/mark_all_read/" method="post">
    {% csrf_token %}
    <button type="submit" formaction="/api/notifications/mark_all_read/">Mark all read</button>
  </form>
</section>

{% if user.role == "teacher" %}
<section>
  <h3>Your Courses (Teacher)</h3>
  <ul>
    {% for c in my_courses_taught %}
      <li><a href="/courses/{{ c.slug }}/">{{ c.title }}</a></li>
    {% empty %}<li>You haven’t created any courses yet.</li>{% endfor %}
  </ul>
</section>
<section>
  <h3>Recently Uploaded Materials</h3>
  <ul>
    {% for m in my_materials %}
      <li>{{ m.title }} — <a href="{{ m.file.url }}">download</a></li>
    {% empty %}<li>No materials yet.</li>{% endfor %}
  </ul>
</section>
{% else %}
<section>
  <h3>Your Enrollments</h3>
  <ul>
    {% for e in my_enrollments %}
      <li><a href="/courses/{{ e.course.slug }}/">{{ e.course.title }}</a></li>
    {% empty %}<li>Not enrolled in any course yet.</li>{% endfor %}
  </ul>
</section>
{% endif %}

<!-- Chat UI -->
<section>
  <h3>Chat</h3>
  <label for="chat-user-select">Chat with:</label>
  <select id="chat-user-select" onchange="changeReceiver()">
    {% for u in users %}
      {% if u != request.user %}
        <option value="{{ u.username }}">{{ u.username }}</option>
      {% endif %}
    {% endfor %}
  </select>

  <div id="chat-container" style="margin-top: 10px;">
    <div id="chat-log" style="border: 1px solid #ccc; height: 200px; overflow-y: scroll; padding: 10px;"></div>
    <form id="chat-form">
      <input type="text" id="chat-message-input" placeholder="Type your message..." autocomplete="off" />
      <input type="submit" value="Send" />
    </form>
  </div>
</section>

<script>
  const chatLog = document.getElementById("chat-log");
  const chatForm = document.getElementById("chat-form");
  const chatMessageInput = document.getElementById("chat-message-input");
  const username = "{{ request.user.username }}";
  let chatSocket;

  function changeReceiver() {
    const receiver = document.getElementById("chat-user-select").value;
    if (chatSocket) chatSocket.close();

    chatSocket = new WebSocket(
      "ws://" + window.location.host + "/ws/chat/" + receiver + "/"
    );

    chatSocket.onmessage = function (e) {
      const data = JSON.parse(e.data);
      const messageEl = document.createElement("div");
      messageEl.innerText = data.sender + ": " + data.message;
      chatLog.appendChild(messageEl);
      chatLog.scrollTop = chatLog.scrollHeight;
    };
  }

  window.onload = function () {
    changeReceiver();
  };

  chatForm.onsubmit = function (e) {
    e.preventDefault();
    const message = chatMessageInput.value;
    if (message.trim()) {
      chatSocket.send(JSON.stringify({ message: message, sender: username }));
      chatMessageInput.value = "";
    }
  };
</script>

{% endblock %}
