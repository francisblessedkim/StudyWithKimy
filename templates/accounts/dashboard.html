{% extends "base.html" %}
{% block title %}Dashboard Â· StudyWithKimy{% endblock %}

{% block content %}
  <!-- Header -->
  <section class="mb-8">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">Welcome back, 
          {{ user.first_name|default:user.username }} ðŸ‘‹
        </h1>
        <p class="mt-1 text-slate-600">Your learning hub at a glance.</p>
      </div>
      <span class="hidden sm:inline-flex items-center rounded-xl px-3 py-1 text-xs font-semibold text-white bg-gradient-to-br from-blue-500 via-blue-600 to-indigo-600">
        {{ user.role|default:"student" }}
      </span>
    </div>
  </section>

  <!-- Stats -->
  <section class="grid gap-4 sm:gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 mb-10">
    {% if user.role == "teacher" %}
      <div class="card p-5">
        <p class="text-sm text-slate-500">Courses Taught</p>
        <p class="mt-2 text-2xl font-bold">{{ my_courses_taught|length }}</p>
      </div>
      <div class="card p-5">
        <p class="text-sm text-slate-500">Materials</p>
        <p class="mt-2 text-2xl font-bold">{{ my_materials|length }}</p>
      </div>
      <div class="card p-5">
        <p class="text-sm text-slate-500">Enrolments</p>
        <p class="mt-2 text-2xl font-bold">{{ my_enrollments|length }}</p>
      </div>
      <div class="card p-5">
        <p class="text-sm text-slate-500">Notifications</p>
        <p class="mt-2 text-2xl font-bold">{{ notifications|length }}</p>
      </div>
    {% else %}
      <div class="card p-5">
        <p class="text-sm text-slate-500">Enrolled Courses</p>
        <p class="mt-2 text-2xl font-bold">{{ my_enrollments|length }}</p>
      </div>
      <div class="card p-5">
        <p class="text-sm text-slate-500">Notifications</p>
        <p class="mt-2 text-2xl font-bold">{{ notifications|length }}</p>
      </div>
      <div class="card p-5">
        <p class="text-sm text-slate-500">Materials</p>
        <p class="mt-2 text-2xl font-bold">{{ my_materials|length }}</p>
      </div>
      <div class="card p-5">
        <p class="text-sm text-slate-500">Peers</p>
        <p class="mt-2 text-2xl font-bold">{{ users|length }}</p>
      </div>
    {% endif %}
  </section>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Courses -->
    <section class="lg:col-span-2 space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">My Courses</h2>
        <a href="/courses/" class="text-sm font-medium text-blue-700 hover:underline">Browse all</a>
      </div>

      <div class="grid sm:grid-cols-2 xl:grid-cols-3 gap-4">
        {% if user.role == "teacher" %}
          {% for c in my_courses_taught %}
            <article class="card overflow-hidden group">
              <!-- <div class="h-24 bg-gradient-to-br from-blue-50 to-indigo-50"></div> -->
              {% if c.thumbnail %}
                <img src="{{ c.thumbnail.url }}" alt="" class="h-24 w-full object-cover" loading="lazy">
              {% else %}
                <div class="h-24 w-full bg-gradient-to-br from-blue-50 to-indigo-50"></div>
              {% endif %}
              <div class="p-5">
                <h3 class="font-semibold group-hover:text-blue-700 transition-all">{{ c.title }}</h3>
                <p class="mt-1 text-sm text-slate-600 line-clamp-2">{{ c.short_description|default:c.description|truncatewords:20 }}</p>
                <div class="mt-4 flex items-center justify-between">
                  <a href="/courses/{{ c.slug }}/" class="btn-ghost">View</a>
                  <a href="{% url 'course_detail' c.slug %}#materials" class="btn-primary">Materials</a>
                </div>
              </div>
            </article>
          {% empty %}
            <div class="col-span-full card p-6 text-slate-600">No courses yet. Create one from the Courses page.</div>
          {% endfor %}
        {% else %}
          {% for e in my_enrollments %}
            {% with c=e.course %}
            <article class="card overflow-hidden group">
              <!-- <div class="h-24 bg-gradient-to-br from-blue-50 to-indigo-50"></div> -->
              {% if c.thumbnail %}
                <img src="{{ c.thumbnail.url }}" alt="" class="h-24 w-full object-cover" loading="lazy">
              {% else %}
                <div class="h-24 w-full bg-gradient-to-br from-blue-50 to-indigo-50"></div>
              {% endif %}
              <div class="p-5">
                <h3 class="font-semibold group-hover:text-blue-700 transition-all">{{ c.title }}</h3>
                <p class="mt-1 text-sm text-slate-600 line-clamp-2">{{ c.short_description|default:c.description|truncatewords:20 }}</p>
                <div class="mt-4 flex items-center justify-between">
                  <a href="/courses/{{ c.slug }}/" class="btn-primary">Continue</a>
                  <a href="/courses/" class="btn-ghost">All courses</a>
                </div>
              </div>
            </article>
            {% endwith %}
          {% empty %}
            <div class="col-span-full card p-6 text-slate-600">You havenâ€™t enrolled in any courses yet.</div>
          {% endfor %}
        {% endif %}
      </div>
    </section>

    <!-- Status composer -->
<section class="card p-4 mb-6">
  <form method="post" action="{% url 'social:post_status' %}" class="grid grid-cols-[1fr_auto] gap-3 items-start">
    {% csrf_token %}
    <input type="hidden" name="next" value="{{ request.get_full_path }}">
    <textarea name="text" rows="2" maxlength="280" class="input resize-y" placeholder="Share an updateâ€¦"></textarea>
    <button class="btn-primary h-input px-5 place-self-end" type="submit">Post</button>
  </form>

</section>

<!-- My recent updates -->
<section class="card p-4">
  <h2 class="font-semibold">My recent updates</h2>
  <ul class="mt-3 space-y-3">
    {% for s in my_updates %}
      <li class="border border-slate-200 rounded-xl p-3">
        <p class="text-slate-800">{{ s.text }}</p>
        <div class="mt-2 flex items-center justify-between text-xs text-slate-500">
          <span>{{ s.created_at|date:"M d, Y Â· H:i" }}</span>
          <form method="post" action="{% url 'social:delete_status' s.pk %}">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button class="text-slate-500 hover:text-rose-600" type="submit">Delete</button>
          </form>
        </div>
      </li>
    {% empty %}
      <li class="text-slate-600">No updates yet. Say hello above!</li>
    {% endfor %}
  </ul>
</section>

<!-- Notifications -->
<section class="card p-4 mt-6">
  <h2 class="font-semibold">Notifications</h2>
  <ul class="mt-3 space-y-2">
    {% for n in notifications %}
      <li class="border border-slate-200 rounded-xl p-3 text-sm">
        {% if n.type == "enrolment" %}
          <span class="font-medium">@{{ n.payload.student_username }}</span> enrolled in
          <span class="font-medium">{{ n.payload.course_title }}</span>.
        {% elif n.type == "new_material" %}
          New material <span class="font-medium">{{ n.payload.material_title }}</span>
          added to <span class="font-medium">{{ n.payload.course_title }}</span>.
        {% else %}
          Update received.
        {% endif %}
        <span class="ml-2 text-xs text-slate-500">{{ n.created_at|date:"M d, Y Â· H:i" }}</span>
      </li>
    {% empty %}
      <li class="text-slate-600">No notifications yet.</li>
    {% endfor %}
  </ul>
</section>



    <!-- Sidebar: Activity + People -->
    <aside class="space-y-6">
      <!-- Activity -->
      <section class="card p-5">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold">Activity</h3>
          <span class="text-xs text-slate-500">{{ notifications|length }} updates</span>
        </div>
        <ul class="space-y-3">
          {% for n in notifications %}
            <li class="text-sm text-slate-700 flex gap-2">
              <span class="h-2.5 w-2.5 mt-1.5 rounded-full bg-blue-600/80"></span>
              <span>{{ n }}</span>
            </li>
          {% empty %}
            <li class="text-sm text-slate-600">No recent notifications.</li>
          {% endfor %}
        </ul>
      </section>

      <!-------Upcoming Deadlines---------->
      <section class="card p-5">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold">Upcoming deadlines</h3>
        <span class="text-xs text-slate-500">{{ upcoming_assignments|length }}</span>
      </div>
      <ul class="space-y-2">
        {% for a in upcoming_assignments %}
          <li class="text-sm flex items-center justify-between">
            <div class="truncate">
              <span class="font-medium">{{ a.title }}</span>
              <span class="text-slate-500"> â€” {{ a.course.title }}</span>
            </div>
            <span class="text-xs text-slate-500">{{ a.due_date|date:"M d, H:i" }}</span>
          </li>
        {% empty %}
          <li class="text-sm text-slate-600">No upcoming deadlines.</li>
        {% endfor %}
      </ul>
    </section>


      <!-- Materials (teacher and student see their list) -->
      <section class="card p-5">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold">My Materials</h3>
          <span class="text-xs text-slate-500">{{ my_materials|length }}</span>
        </div>
        <ul class="space-y-2">
          {% for m in my_materials %}
            <li class="text-sm flex items-center justify-between">
              <span class="truncate">{{ m.title|default:m.file.name|default:"Material" }}</span>
              <a href="{{ m.file.url|default:'#' }}" class="text-blue-700 hover:underline">View</a>
            </li>
          {% empty %}
            <li class="text-sm text-slate-600">No materials yet.</li>
          {% endfor %}
        </ul>
      </section>

      <!-- People (for chat) -->
      <section class="card p-5">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold">People</h3>
          <span class="text-xs text-slate-500">{{ users|length }}</span>
        </div>
        <ul class="space-y-2">
          {% for u in users %}
            <li class="text-sm flex items-center justify-between">
              <span>@{{ u.username }}</span>
              <!-- Replace href with your chat URL if you have one -->
              <!-- <a href="/chat/{{ u.username }}/" class="btn-ghost">Message</a> -->
               <a href="{% url 'public_profile' u.username %}" class="btn-ghost">View Profile</a>
               <a href="{% url 'chat:room' u.username %}" class="btn-ghost">Message</a>
            </li>
          {% empty %}
            <li class="text-sm text-slate-600">No users found.</li>
          {% endfor %}
        </ul>
      </section>
    </aside>
  </div>
{% endblock %}
